{% extends "base.html" %}
{% load static %}
{% load float_filters %}

{% block title %}
Climate Hazard Analysis Results
{% endblock %}

{% block content %}
<!-- Add CSRF token for AJAX requests -->
{% csrf_token %}

<style>
    /* Progress Steps Styling */
    .steps-container {
        padding: 20px 0;
    }

    .step-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
    }

    .step-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        margin-bottom: 10px;
        z-index: 3;
        transition: background-color 0.3s ease, color 0.3s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .step-label {
        text-align: center;
        font-weight: 500;
        max-width: 120px;
        transition: color 0.3s ease;
        font-size: 14px;
        margin-top: 5px;
    }

    .progress-line {
        position: absolute;
        height: 3px;
        background-color: #e9ecef;
        top: 25px;
        width: 100%;
        z-index: 1;
    }

    .active-progress {
        position: absolute;
        height: 3px;
        background-color: #F1D500;
        top: 25px;
        z-index: 2;
        transition: width 0.5s ease;
    }

    /* Custom Table Styling */
    .custom-table {
        background-color: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: none;
        width: 100%;
        border-collapse: collapse;
        border-spacing: 0 8px;
    }

    .custom-table th,
    .custom-table td {
        border-right: 1px solid #ccc;
        padding: 8px;
    }

    .custom-table-header {
        background-color: #F8F8F8;
        color: #495057;
        font-weight: 600;
        text-align: center;
        border: none;
        padding: 15px 10px;
        vertical-align: middle;
        font-size: 14px;
    }

    .custom-table-row:nth-child(even) {
        background-color: #f8f9fa;
    }

    .custom-table-row:hover {
        background-color: #e9ecef;
        transition: background-color 0.3s ease;
    }

    .custom-table td {
        border: none;
        padding: 12px 10px;
        text-align: center;
        vertical-align: middle;
        font-size: 13px;
    }

    /* Custom Card Styling */
    .custom-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .custom-card .card-header {
        background-color: #f8f9fa;
        border-bottom: none;
        border-radius: 15px 15px 0 0;
        padding: 20px;
        font-weight: 600;
        color: #495057;
    }

    .no-border {
        border: none !important;
    }

    /* Tab Styling */
    .custom-tabs-nav {
        flex-wrap: nowrap !important;
        overflow-x: auto;
    }
    
    .custom-tabs-nav .nav-item {
        flex: 0 0 auto;
    }
    
    .custom-tab-link {
        border: none;
        color: #495057;
        font-weight: 500;
        padding: 12px 20px;
        margin-right: 5px;
        border-radius: 10px 10px 0 0;
        background-color: transparent;
        transition: all 0.3s ease;
    }

    .custom-tab-link.active {
        background-color: #F1D500;
        color: #000;
        font-weight: 600;
    }

    .custom-tab-link:hover {
        background-color: #ffeaa7;
        color: #000;
    }

    /* Alert fade animation */
    .alert-fade {
        animation: fadeOut 5s forwards;
    }

    @keyframes fadeOut {
        0% { opacity: 1; }
        80% { opacity: 1; }
        100% { opacity: 0; }
    }

    /* Column selector card styling */
    .column-selector {
        max-height: 500px;
        overflow-y: auto;
    }
    
    .column-selector .form-check {
        margin-bottom: 0.5rem;
    }
    
    .column-selector .fw-bold {
        font-weight: bold !important;
    }

    .column-selector-card {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .column-selector-card h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 15px;
    }

    .form-check {
        margin-bottom: 8px;
    }

    .form-check-input:checked {
        background-color: #F1D500;
        border-color: #F1D500;
    }

    .form-check-label {
        font-size: 14px;
        color: #495057;
    }

    /* Group header colors for different hazards */
    .group-header th {
        background-color: #f1f1f1;
        font-weight: bold;
        text-align: center;
        border: 1px solid #ddd;
        padding: 8px;
        color: #333;
    }

    .group-header th:nth-child(1) {
        background-color: #e3f2fd; /* Facility Information - light blue */
    }

    .group-header th:nth-child(2) {
        background-color: #e8f5e8; /* Water Stress - light green */
    }

    .group-header th:nth-child(3) {
        background-color: #fff3e0; /* Sea Level Rise - light orange */
    }

    .group-header th:nth-child(4) {
        background-color: #fce4ec; /* Tropical Cyclone - light pink */
    }

    .group-header th:nth-child(5) {
        background-color: #ffebee; /* Flood - light red */
    }

    .group-header th:nth-child(6) {
        background-color: #ffe5d0; /* Heat - light orange */
    }

    .group-header th:nth-child(7) {
        background-color: #cff4fc; /* Storm Surge - light cyan */
    }

    .group-header th:nth-child(8) {
        background-color: #e2e3e5; /* Rainfall-Induced Landslide - light gray */
    }

    /* Improved table layout for proportionate columns */
    .dataTables_wrapper {
        overflow-x: auto;
        width: 100%;
    }

    /* Allow table to take full width */
    .dataTables_scrollHeadInner,
    .dataTables_scrollHeadInner table,
    .dataTables_scrollBody,
    .dataTables_scrollBody table {
        width: 100% !important;
    }

    /* Better header wrapping */
    .custom-table thead th {
        white-space: normal;
        word-wrap: break-word;
        vertical-align: top;
        padding: 8px 4px;
    }

    /* Better cell styling for uniform look */
    .custom-table td {
        text-align: center;
        vertical-align: middle;
        padding: 8px 4px;
        word-break: break-word;
    }

    /* Keep header text centered as well */
    .custom-table th {
        text-align: center;
        vertical-align: middle;
    }

    /* Class that DataTables can use for header wrapping */
    .dt-head-wrap {
        white-space: normal !important;
    }

    /* Make sure the fixed first column looks good */
    .DTFC_LeftBodyLiner {
        overflow-x: hidden !important;
    }

    /* Ensure vertical scroll shows when needed */
    .dataTables_scrollBody {
        max-height: 600px;
    }

    /* Center content in DataTables fixed columns too */
    .DTFC_LeftWrapper td, 
    .DTFC_LeftWrapper th {
        text-align: center;
        vertical-align: middle;
    }

    /* EDITABLE TABLE STYLES */
    .editable-cell {
        cursor: pointer;
        position: relative;
    }

    .editable-cell:hover {
        background-color: #f8f9ff !important;
        border: 1px dashed #007bff;
    }

    .editable-cell:hover::after {
        content: "✏️";
        position: absolute;
        top: 2px;
        right: 2px;
        font-size: 10px;
    }

    .cell-changed {
        background-color: #fff3cd !important;
        border-left: 3px solid #ffc107;
    }

    .editing {
        padding: 2px !important;
    }

    .edit-input {
        font-size: 12px !important;
        padding: 2px 4px !important;
        height: auto !important;
        min-height: 25px !important;
    }

    #changes-indicator {
        clear: both;
        display: block;
    }
</style>

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-6 d-flex flex-column">
            <!-- Rounded Icon Container with Margin -->
            <div class="icon-container">
                <img src="{% static 'images/sgv-logo.png' %}" alt="SGV Logo">
            </div>
            <!-- Heading below the icon with Margin -->
            <h1 class="page-heading">Climate Hazard Exposure Analysis</h1>
        </div>
    </div>

    <!-- Step by Step Procedure UI -->
    <div class="row mt-4 mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-4">
                    <div class="steps-container d-flex justify-content-between position-relative">
                        <!-- Progress Line -->
                        <div class="progress-line position-absolute" style="height: 3px; background-color: #e9ecef; top: 25px; width: 100%; z-index: 1;"></div>
                        
                        <!-- Active Progress (60% for step 3 completion) -->
                        <div class="active-progress position-absolute" style="height: 3px; background-color: #F1D500; top: 25px; width: 60%; z-index: 2; transition: width 0.5s ease;"></div>
                        
                        <!-- Step 1 (completed) -->
                        <div class="step-item d-flex flex-column align-items-center position-relative" style="z-index: 3; width: 20%;">
                            <div class="step-circle d-flex justify-content-center align-items-center" style="width: 50px; height: 50px; border-radius: 50%; background-color: #F1D500; color: #000; font-weight: bold; margin-bottom: 10px;">
                                1
                            </div>
                            <div class="step-label text-center" style="font-weight: 500;">Upload Facility Location</div>
                        </div>
                        
                        <!-- Step 2 (completed) -->
                        <div class="step-item d-flex flex-column align-items-center position-relative" style="z-index: 3; width: 20%;">
                            <div class="step-circle d-flex justify-content-center align-items-center" style="width: 50px; height: 50px; border-radius: 50%; background-color: #F1D500; color: #000; font-weight: bold; margin-bottom: 10px;">
                                2
                            </div>
                            <div class="step-label text-center" style="font-weight: 500;">Select Climate/Weather Hazards and Generate Asset Exposure</div>
                        </div>
                        
                        <!-- Step 3 (active) -->
                        <div class="step-item d-flex flex-column align-items-center position-relative" style="z-index: 3; width: 20%;">
                            <div class="step-circle d-flex justify-content-center align-items-center" style="width: 50px; height: 50px; border-radius: 50%; background-color: #F1D500; color: #000; font-weight: bold; margin-bottom: 10px;">
                                3
                            </div>
                            <div class="step-label text-center" style="font-weight: 500;">Asset Exposure Results</div>
                        </div>
                        
                        <!-- Step 4 (upcoming) -->
                        <div class="step-item d-flex flex-column align-items-center position-relative" style="z-index: 3; width: 20%;">
                            <div class="step-circle d-flex justify-content-center align-items-center" style="width: 50px; height: 50px; border-radius: 50%; background-color: #e9ecef; color: #6c757d; font-weight: bold; margin-bottom: 10px;">
                                4
                            </div>
                            <div class="step-label text-center" style="font-weight: 500; color: #6c757d;">Set Sensitivity Parameters</div>
                        </div>
                        
                        <!-- Step 5 (upcoming) -->
                        <div class="step-item d-flex flex-column align-items-center position-relative" style="z-index: 3; width: 20%;">
                            <div class="step-circle d-flex justify-content-center align-items-center" style="width: 50px; height: 50px; border-radius: 50%; background-color: #e9ecef; color: #6c757d; font-weight: bold; margin-bottom: 10px;">
                                5
                            </div>
                            <div class="step-label text-center" style="font-weight: 500; color: #6c757d;">Sensitivity Results</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alert Messages -->
{% if error %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    {{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

{% if success_message %}
<div class="alert alert-success alert-dismissible fade show alert-fade" role="alert">
    {{ success_message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<!-- Results Content -->
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Left Column: Column Selector -->
        <div class="col-md-3">
            {% include "climate_hazards_analysis_v2/column_selector.html" %}
        </div>
        
        <!-- Right Column: Results Table -->
        <div class="col-md-9">
            <div class="card custom-card">
                <div class="card-header no-border">
                    <strong>Hazard Analysis Results</strong>
                </div>
                <div class="card-body">
                    <!-- Tabs Navigation -->
                    <ul class="nav nav-tabs mt-2 custom-tabs-nav" id="hazardTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link custom-tab-link active" id="table-tab" data-bs-toggle="tab" href="#table-content" role="tab" aria-controls="table-content" aria-selected="true">
                                Hazard Exposure Table
                            </a>
                        </li>

                        <li class="nav-item {% if selected_hazards|length <= 1 %}d-none{% endif %}">
                            <a class="nav-link custom-tab-link" id="multi-hazard-map-tab" data-bs-toggle="tab" href="#multi-hazard-map" role="tab" aria-controls="map-content" aria-selected="false">
                                Multi-Hazard Map 
                            </a>
                        </li>

                        {% for hazard in selected_hazards %}
                            {% if hazard == "Heat" %}
                            <li class="nav-item">
                                <a class="nav-link custom-tab-link" id="heat-exposure-map-tab" data-bs-toggle="tab" href="#heat-map" role="tab" aria-controls="map-content" aria-selected="false">
                                    Heat Exposure Map
                                </a>
                            </li>
                            {% elif hazard == "Sea Level Rise" %}
                            <li class="nav-item">
                                <a class="nav-link custom-tab-link" id="sea-level-rise-map-tab" data-bs-toggle="tab" href="#sea-map" role="tab" aria-controls="map-content" aria-selected="false">
                                    Sea Level Rise Exposure Map
                                </a>
                            </li>
                            {% elif hazard == "Flood" %}
                            <li class="nav-item">
                                <a class="nav-link custom-tab-link" id="flood-exposure-map-tab" data-bs-toggle="tab" href="#flood-map" role="tab" aria-controls="map-content" aria-selected="false">
                                    Flood Exposure Map
                                </a>
                            </li>
                            {% elif hazard == "Water Stress" %}
                            <li class="nav-item">
                                <a class="nav-link custom-tab-link" id="water-stress-map-tab" data-bs-toggle="tab" href="#water-map" role="tab" aria-controls="map-content" aria-selected="false">
                                    Water Stress Exposure Map
                                </a>
                            </li>
                            {% elif hazard == "Tropical Cyclones" %}
                            <li class="nav-item">
                                <a class="nav-link custom-tab-link" id="tropical-cyclone-map-tab" data-bs-toggle="tab" href="#cyclone-map" role="tab" aria-controls="map-content" aria-selected="false">
                                    Tropical Cyclone Exposure Map
                                </a>
                            </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
              
                    <!-- Tab Content -->
                    <div class="tab-content mt-3" id="hazardTabsContent">
                        <!-- Facility Locations Table Tab -->
                        <div class="tab-pane fade show active" id="table-content" role="tabpanel" aria-labelledby="table-tab">
                            <!-- Styled Table -->
                            <div class="table-responsive">
                                <table id="data-table" class="table custom-table">
                                    <thead>
                                        <!-- Grouping header row -->
                                        <tr class="group-header">
                                            {% for group, count in groups.items %}
                                                {% if count > 0 %}
                                                    <th colspan="{{ count }}" class="text-center">{{ group }}</th>
                                                {% endif %}
                                            {% endfor %}
                                        </tr>
                                        <tr class="custom-table-header">
                                            {% for column in columns %}
                                                <th>{{ column }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    
                                    <tbody>
    {% for row in data %}
        <tr class="custom-table-row">
            {% for key, value in row.items %}
                <td>
                    {# Water Stress Exposure styling #}
                    {% if key == "Water Stress Exposure (%)" and value != "N/A" %}
                        {% with val=value|to_float %}
                            {% if val < 10 %}
                                <span style="color: green; font-weight: bold;">{{ value }}</span>
                            {% elif val >= 10 and val <= 30 %}
                                <span style="color: orange; font-weight: bold;">{{ value }}</span>
                            {% elif val > 30 %}
                                <span style="color: red; font-weight: bold;">{{ value }}</span>
                            {% else %}
                                {{ value }}
                            {% endif %}
                        {% endwith %}
                    
                    {# Flood Depth styling #}
                    {% elif key == "Flood Depth (meters)" and value != "N/A" %}
                        {% with numeric=value|to_float %}
                            {% if value == "Little to none" or numeric < 0.1 %}
                                <span style="color: black; font-weight: bold;">Little to none</span>
                            {% elif value == "0.1 to 0.5" or numeric >= 0.1 and numeric < 0.5 %}
                                <span style="color: green; font-weight: bold;">0.1 to 0.5</span>
                            {% elif value == "0.5 to 1.5" or numeric >= 0.5 and numeric <= 1.5 %}
                                <span style="color: orange; font-weight: bold;">0.5 to 1.5</span>
                            {% elif value == ">1.5" or value == "Greater than 1.5" or numeric > 1.5 %}
                                <span style="color: red; font-weight: bold;">&gt;1.5</span>
                            {% else %}
                                {{ value }}
                            {% endif %}
                        {% endwith %}
                    
                    {# Heat indicators styling #}
                    {% elif "Days over" in key and "Celsius" in key and value != "N/A" %}
                        {% with val=value|to_float %}
                            {% if "30°" in key %}
                                {% if val > 200 %}
                                    <span style="color: red; font-weight: bold;">{{ value }}</span>
                                {% elif val > 100 %}
                                    <span style="color: orange; font-weight: bold;">{{ value }}</span>
                                {% else %}
                                    <span style="color: green; font-weight: bold;">{{ value }}</span>
                                {% endif %}
                            {% elif "33°" in key %}
                                {% if val > 50 %}
                                    <span style="color: red; font-weight: bold;">{{ value }}</span>
                                {% elif val > 20 %}
                                    <span style="color: orange; font-weight: bold;">{{ value }}</span>
                                {% else %}
                                    <span style="color: green; font-weight: bold;">{{ value }}</span>
                                {% endif %}
                            {% elif "35°" in key %}
                                {% if val > 10 %}
                                    <span style="color: red; font-weight: bold;">{{ value }}</span>
                                {% elif val > 5 %}
                                    <span style="color: orange; font-weight: bold;">{{ value }}</span>
                                {% else %}
                                    <span style="color: green; font-weight: bold;">{{ value }}</span>
                                {% endif %}
                            {% else %}
                                {{ value }}
                            {% endif %}
                        {% endwith %}
                    
                    {# Sea Level Rise styling #}
                    {% elif "Sea Level Rise" in key and value != "N/A" %}
                        {% with val=value|to_float %}
                            {% if val > 0.5 %}
                                <span style="color: red; font-weight: bold;">{{ value }}</span>
                            {% elif val > 0.3 %}
                                <span style="color: orange; font-weight: bold;">{{ value }}</span>
                            {% else %}
                                <span style="color: green; font-weight: bold;">{{ value }}</span>
                            {% endif %}
                        {% endwith %}
                    
                    {# Tropical Cyclone Wind Speed styling #}
                    {% elif "Windspeed" in key and "km/h" in key and value != "N/A" %}
                        {% with val=value|to_float %}
                            {% if val > 150 %}
                                <span style="color: red; font-weight: bold;">{{ value }}</span>
                            {% elif val > 100 %}
                                <span style="color: orange; font-weight: bold;">{{ value }}</span>
                            {% else %}
                                <span style="color: green; font-weight: bold;">{{ value }}</span>
                            {% endif %}
                        {% endwith %}
                    
                    {# Storm Surge styling #}
                    {% elif "Storm Surge" in key and value != "N/A" %}
                        {% with val=value|to_float %}
                            {% if val > 2.0 %}
                                <span style="color: red; font-weight: bold;">{{ value }}</span>
                            {% elif val > 1.0 %}
                                <span style="color: orange; font-weight: bold;">{{ value }}</span>
                            {% else %}
                                <span style="color: green; font-weight: bold;">{{ value }}</span>
                            {% endif %}
                        {% endwith %}
                    
                    {# Rainfall-Induced Landslide styling #}
                    {% elif "Landslide Factor" in key and value != "N/A" %}
                        {% with val=value|to_float %}
                            {% if val < 1.0 %}
                                <span style="color: red; font-weight: bold;">{{ value }}</span>
                            {% elif val < 1.5 %}
                                <span style="color: orange; font-weight: bold;">{{ value }}</span>
                            {% else %}
                                <span style="color: green; font-weight: bold;">{{ value }}</span>
                            {% endif %}
                        {% endwith %}
                    
                    {# Default cell display #}
                    {% else %}
                        {{ value }}
                    {% endif %}
                </td>
            {% endfor %}
        </tr>
    {% endfor %}
</tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Multi-Hazard Map Tab -->
                        <div class="tab-pane fade text-center" id="multi-hazard-map" role="tabpanel" aria-labelledby="multi-hazard-map-tab">
                            <h2>Multi-Hazard Map</h2>
                            <div id="multi-hazard-map-content"></div>
                        </div>

                        <!-- Individual Hazard Map Tabs -->
                        {% for hazard in selected_hazards %}
                            {% if hazard == "Heat" %}
                            <div class="tab-pane fade text-center" id="heat-map" role="tabpanel" aria-labelledby="heat-exposure-map-tab">
                                <h2>Heat Exposure Map</h2>
                                <div id="heat-map-content"></div>
                            </div>
                            {% elif hazard == "Sea Level Rise" %}
                            <div class="tab-pane fade text-center" id="sea-map" role="tabpanel" aria-labelledby="sea-level-rise-map-tab">
                                <h2>Sea Level Rise Exposure Map</h2>
                                <div id="sea-map-content"></div>
                            </div>
                            {% elif hazard == "Flood" %}
                            <div class="tab-pane fade text-center" id="flood-map" role="tabpanel" aria-labelledby="flood-exposure-map-tab">
                                <h2>Flood Exposure Map</h2>
                                <div id="flood-map-content"></div>
                            </div>
                            {% elif hazard == "Water Stress" %}
                            <div class="tab-pane fade text-center" id="water-map" role="tabpanel" aria-labelledby="water-stress-map-tab">
                                <h2>Water Stress Exposure Map</h2>
                                <div id="water-map-content"></div>
                            </div>
                            {% elif hazard == "Tropical Cyclones" %}
                            <div class="tab-pane fade text-center" id="cyclone-map" role="tabpanel" aria-labelledby="tropical-cyclone-map-tab">
                                <h2>Tropical Cyclone Exposure Map</h2>
                                <div id="cyclone-map-content"></div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Navigation buttons -->
<div class="row mt-4 mb-5">
    <div class="col-12 d-flex justify-content-between">
        <div class="d-flex gap-2">
            <a href="{% url 'climate_hazards_analysis_v2:select_hazards' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i> Back to Select Climate/Weather Hazards
            </a>
            <a href="{% url 'climate_hazards_analysis_v2:view_map' %}" class="btn btn-primary">
                <i class="fas fa-arrow-left me-2"></i> Return to Upload Facility Location
            </a>
        </div>
        <div>
            <a href="#" class="btn btn-warning btn-lg" onclick="proceedToSensitivityParameters()">
                <strong>Proceed to Set Sensitivity Parameters</strong>
                <i class="fas fa-arrow-right ms-2"></i>
            </a>
        </div>
    </div>
</div>
</div>

<!-- Include DataTables CSS & JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.2.2/css/fixedColumns.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/fixedcolumns/4.2.2/js/dataTables.fixedColumns.min.js"></script>

<script>

let dataTable;
let cellChanges = {};
$(document).ready(function() {
    try {
        console.log('Initializing Asset Exposure Results...');

        dataTable = $('#data-table').DataTable({
            scrollX: true,
            scrollCollapse: true,
            fixedHeader: true,
            autoWidth: true,
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'excelHtml5',
                    text: '<i class="fas fa-file-excel"></i> Save to Excel',
                    className: 'btn btn-outline-secondary',
                    exportOptions: {
                        columns: ':visible'
                    }
                },
                {
                    text: '<i class="fas fa-save"></i> Save All Changes',
                    className: 'btn btn-success',
                    action: function(e, dt, node, config) {
                        saveAllChanges();
                    }
                },
                {
                    text: '<i class="fas fa-undo"></i> Reset Changes',
                    className: 'btn btn-warning',
                    action: function(e, dt, node, config) {
                        resetAllChanges();
                    }
                }
            ],
            fixedColumns: {
                leftColumns: 1
            },
            columnDefs: [
                { targets: [1, 2], visible: false },
                { width: '18%', targets: 0 },
                { width: '10%', targets: '_all' },
                { className: "dt-head-center dt-body-center", targets: "_all" },
                {
                    targets: '_all',
                    createdCell: function(td, cellData, rowData, row, col) {
                        setTimeout(function() {
                            const columnName = dataTable.column(col).header().textContent.trim();
                            const editableColumns = [
                                'Flood Depth (meters)', 'Water Stress Exposure (%)',
                                'Days over 30° Celsius', 'Days over 33° Celsius', 'Days over 35° Celsius',
                                '2030 Sea Level Rise (in meters)', '2040 Sea Level Rise (in meters)',
                                '2050 Sea Level Rise (in meters)', '2060 Sea Level Rise (in meters)',
                                'Elevation (meter above sea level)',
                                'Extreme Windspeed 10 year Return Period (km/h)',
                                'Extreme Windspeed 20 year Return Period (km/h)',
                                'Extreme Windspeed 50 year Return Period (km/h)',
                                'Extreme Windspeed 100 year Return Period (km/h)',
                                'Storm Surge Flood Depth (meters)',
                                'Rainfall Induced Landslide Factor of Safety'
                            ];

                            if (editableColumns.includes(columnName)) {
                                $(td).addClass('editable-cell');
                                $(td).attr('data-original-value', cellData);
                                $(td).attr('data-column', columnName);
                                $(td).attr('data-row', row);
                                $(td).attr('title', 'Click to edit');
                            }
                        }, 10);
                    }
                }
            ],
            initComplete: function() {
                console.log('DataTable initialization complete');
                setTimeout(() => {
                    setupColumnSelector();
                    updateColumnVisibility();
                    setTimeout(() => {
                        attachEditableHandlers();
                        console.log('All functionality initialized');
                    }, 200);
                }, 100);
            },
            drawCallback: function() {
                setTimeout(() => {
                    attachEditableHandlers();
                }, 100);
            }
        });

        console.log('DataTable initialized successfully');

    } catch (error) {
        console.error('Error initializing DataTable:', error);
    }

    let resizeTimeout;
    $(window).on('resize', function() {
        if (dataTable) {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                dataTable.columns.adjust();
            }, 250);
        }
    });
});

// FIXED: Improved editable table functionality
function attachEditableHandlers() {
    // Remove any existing handlers to prevent duplicates
    $('.editable-cell').off('click.editable');
    
    // Add click handlers to editable cells
    $('.editable-cell').on('click.editable', function() {
        editCell($(this));
    });
    
    const editableCount = $('.editable-cell').length;
    console.log(`Attached handlers to ${editableCount} editable cells`);
}

function editCell($cell) {
    if ($cell.hasClass('editing')) {
        return;
    }
    
    const currentValue = $cell.text().trim();
    const columnName = $cell.attr('data-column');
    const rowIndex = parseInt($cell.attr('data-row'));
    
    const inputType = getInputType(columnName);
    const $input = $(`<input type="${inputType}" class="form-control edit-input" value="${currentValue}">`);
    
    $input.css({
        'width': '100%',
        'border': '2px solid #007bff',
        'background-color': '#f8f9ff'
    });
    
    $cell.addClass('editing').html($input);
    $input.focus().select();
    
    $input.on('blur keydown', function(e) {
        if (e.type === 'blur' || e.key === 'Enter') {
            e.preventDefault();
            saveCell($cell, $input, rowIndex, columnName);
        } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelEdit($cell, currentValue);
        }
    });
}

function getInputType(columnName) {
    const percentageColumns = ['Water Stress Exposure (%)'];
    const numberColumns = [
        'Flood Depth (meters)', 'Days over 30° Celsius', 'Days over 33° Celsius',
        'Days over 35° Celsius', '2030 Sea Level Rise (in meters)',
        '2040 Sea Level Rise (in meters)', '2050 Sea Level Rise (in meters)',
        '2060 Sea Level Rise (in meters)', 'Elevation (meter above sea level)',
        'Storm Surge Flood Depth (meters)', 'Rainfall Induced Landslide Factor of Safety'
    ];
    
    if (percentageColumns.includes(columnName) || numberColumns.includes(columnName)) {
        return 'number';
    }
    return 'text';
}

function categorizeFloodDepth(value) {
    const num = parseFloat(value);
    if (!isNaN(num)) {
        if (num > 1.5) {
            return { text: '>1.5', color: 'red' };
        }
        if (num >= 0.5) {
            return { text: '0.5 to 1.5', color: 'orange' };
        }
        if (num >= 0.1) {
            return { text: '0.1 to 0.5', color: 'green' };
        }
        return { text: 'Little to none', color: 'black' };
    }

    const normalized = String(value).toLowerCase();
    if (normalized.includes('little')) {
        return { text: 'Little to none', color: 'black' };
    }
    if (normalized.includes('0.1') && normalized.includes('0.5')) {
        return { text: '0.1 to 0.5', color: 'green' };
    }
    if (normalized.includes('0.5') && normalized.includes('1.5')) {
        return { text: '0.5 to 1.5', color: 'orange' };
    }
    if (normalized.includes('1.5')) {
        return { text: '>1.5', color: 'red' };
    }
    return { text: value, color: 'black' };
}

function saveCell($cell, $input, rowIndex, columnName) {
    let newValue = $input.val().trim();
    const originalValue = $cell.attr('data-original-value');

    let displayHTML = newValue;

    if (columnName === 'Flood Depth (meters)' && newValue !== 'N/A') {
        const fd = categorizeFloodDepth(newValue);
        displayHTML = `<span style="color: ${fd.color}; font-weight: bold;">${fd.text}</span>`;
        newValue = fd.text;
    }
    
    if (!validateCellValue(newValue, columnName)) {
        alert(`Invalid value for ${columnName}. Please enter a valid number.`);
        cancelEdit($cell, $cell.text().trim());
        return;
    }
    
    $cell.removeClass('editing').html(displayHTML);
    
    if (newValue !== originalValue) {
        $cell.addClass('cell-changed');
        const cellKey = `${rowIndex}-${columnName}`;
        cellChanges[cellKey] = {
            rowIndex: rowIndex,
            column: columnName,
            oldValue: originalValue,
            newValue: newValue
        };
    } else {
        $cell.removeClass('cell-changed');
        const cellKey = `${rowIndex}-${columnName}`;
        delete cellChanges[cellKey];
    }
    
    updateChangeIndicator();
}

function cancelEdit($cell, originalValue) {
    $cell.removeClass('editing').html(originalValue);
}

function validateCellValue(value, columnName) {
    if (value === '' || value === null || value === undefined) {
        return false;
    }
    
    const numberColumns = [
        'Flood Depth (meters)', 'Water Stress Exposure (%)',
        'Days over 30° Celsius', 'Days over 33° Celsius', 'Days over 35° Celsius',
        '2030 Sea Level Rise (in meters)', '2040 Sea Level Rise (in meters)',
        '2050 Sea Level Rise (in meters)', '2060 Sea Level Rise (in meters)',
        'Elevation (meter above sea level)', 'Storm Surge Flood Depth (meters)',
        'Rainfall Induced Landslide Factor of Safety'
    ];

    if (columnName === 'Flood Depth (meters)') {
        const numValue = parseFloat(value);
        if (!isNaN(numValue) && isFinite(numValue)) {
            return true;
        }
        const normalized = String(value).toLowerCase();
        return ['little to none', '0.1 to 0.5', '0.5 to 1.5', '>1.5', 'greater than 1.5'].includes(normalized);
    }
    
    if (numberColumns.includes(columnName)) {
        const numValue = parseFloat(value);
        return !isNaN(numValue) && isFinite(numValue);
    }
    
    return true;
}

function updateChangeIndicator() {
    const changeCount = Object.keys(cellChanges).length;
    let indicator = $('#changes-indicator');
    
    if (changeCount > 0) {
        if (indicator.length === 0) {
            indicator = $('<div id="changes-indicator" class="alert alert-warning mt-2"></div>');
            $('.dt-buttons').after(indicator);
        }
        indicator.html(`<strong>⚠️ ${changeCount} unsaved change(s)</strong> - Click "Save All Changes" to save your edits.`);
    } else {
        indicator.remove();
    }
}

function setupColumnSelector() {
    if (!dataTable || typeof dataTable.column !== 'function') {
        console.error('DataTable not ready for column selector');
        return;
    }

    $('.base-column, .hazard-column').on('change', function () {
        if ($(this).hasClass('hazard-column')) {
            updateParentCheckboxState($(this));
        }
        updateColumnVisibility();
    });

    $('.hazard-group').on('change', function () {
        const group = $(this).data('hazard');
        const isChecked = $(this).is(':checked');
        $(`.hazard-column.${group}`).prop('checked', isChecked);
        updateColumnVisibility();
    });

    $('#show-all-columns').on('click', function () {
        $('.hazard-column').prop('checked', true);
        $('.base-column:not([disabled])').prop('checked', true);
        updateParentCheckboxes();
        updateColumnVisibility();
    });

    $('#hide-all-columns').on('click', function () {
        $('.hazard-column').prop('checked', false);
        $('.base-column:not([disabled])').prop('checked', false);
        updateParentCheckboxes();
        updateColumnVisibility();
    });
}

// FIXED: Improved column visibility update function
function updateColumnVisibility() {
    if (!dataTable) {
        console.error("DataTable not initialized");
        return;
    }
    
    try {
        console.log('Updating column visibility...');
        
        // Create column mapping more reliably
        const columnMap = {};
        dataTable.columns().every(function(index) {
            const headerText = $(this.header()).text().trim();
            columnMap[headerText] = index;
            console.log(`Column ${index}: "${headerText}"`);
        });
        
        // Always show Facility column
        const visibleColumns = new Set(['Facility']);
        
        // Handle base columns (Lat/Long)
        $('.base-column').each(function() {
            const columnName = $(this).data('column');
            const isChecked = $(this).prop('checked');
            
            if (isChecked && columnMap.hasOwnProperty(columnName)) {
                visibleColumns.add(columnName);
                console.log(`Will show base column: ${columnName}`);
            }
        });
        
        // Handle hazard columns
        $('.hazard-column').each(function() {
            const columnName = $(this).data('column');
            const isChecked = $(this).prop('checked');
            
            console.log(`Checkbox for "${columnName}": ${isChecked}`);
            
            if (isChecked && columnMap.hasOwnProperty(columnName)) {
                visibleColumns.add(columnName);
                console.log(`Will show hazard column: ${columnName}`);
            }
        });
        
        // Update column visibility
        let changesCount = 0;
        dataTable.columns().every(function() {
            const headerText = $(this.header()).text().trim();
            const shouldBeVisible = visibleColumns.has(headerText);
            
            if (this.visible() !== shouldBeVisible) {
                this.visible(shouldBeVisible, false); // false = no immediate redraw
                changesCount++;
            }
        });
        
        console.log(`Changed visibility for ${changesCount} columns`);
        
        // Single redraw after all changes
        if (changesCount > 0) {
            dataTable.columns.adjust().draw(false);
        }
        
        // Re-attach editable handlers after column changes
        setTimeout(function() {
            attachEditableHandlers();
            $(window).trigger('resize');
        }, 100);
        
        console.log('Column visibility update complete');
        
    } catch (error) {
        console.error("Error updating column visibility:", error);
    }
}

// Helper function to update a specific parent checkbox state
function updateParentCheckboxState(changedCheckbox) {
    const classes = changedCheckbox.attr('class').split(' ');
    const hazardClass = classes.find(cls => 
        cls !== 'form-check-input' && cls !== 'hazard-column' && cls !== 'facility-info');
    
    if (!hazardClass) {
        console.log('No hazard class found for checkbox');
        return;
    }
    
    const parentCheckbox = $(`.hazard-group[data-hazard="${hazardClass}"]`);
    const childCheckboxes = $(`.hazard-column.${hazardClass}`);
    const checkedChilds = $(`.hazard-column.${hazardClass}:checked`);
    
    if (parentCheckbox.length > 0) {
        parentCheckbox.prop('checked', checkedChilds.length > 0);
        parentCheckbox.prop('indeterminate', 
            checkedChilds.length > 0 && checkedChilds.length < childCheckboxes.length);
    }
}

// Helper function to update all parent checkbox states
function updateParentCheckboxes() {
    $('.hazard-group').each(function() {
        const hazardClass = $(this).data('hazard');
        const childCheckboxes = $(`.hazard-column.${hazardClass}`);
        const checkedChilds = $(`.hazard-column.${hazardClass}:checked`);
        
        $(this).prop('checked', checkedChilds.length > 0);
        $(this).prop('indeterminate', 
            checkedChilds.length > 0 && checkedChilds.length < childCheckboxes.length);
    });
}

// Save and reset functions
function saveAllChanges() {
    if (Object.keys(cellChanges).length === 0) {
        alert('No changes to save.');
        return;
    }
    
    const $saveBtn = $('.btn:contains("Save All Changes")');
    const originalText = $saveBtn.html();
    $saveBtn.html('<i class="fas fa-spinner fa-spin"></i> Saving...').prop('disabled', true);
    
    const changesData = {
        changes: Object.values(cellChanges),
        csrf_token: $('[name=csrfmiddlewaretoken]').val()
    };
    
    $.ajax({
        url: '/climate-hazards-v2/save-table-changes/',
        method: 'POST',
        data: JSON.stringify(changesData),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                Object.keys(cellChanges).forEach(cellKey => {
                    const change = cellChanges[cellKey];
                    const $cell = $(`.editable-cell[data-row="${change.rowIndex}"][data-column="${change.column}"]`);
                    $cell.attr('data-original-value', change.newValue);
                    $cell.removeClass('cell-changed');
                });
                
                cellChanges = {};
                updateChangeIndicator();
                
                alert('Changes saved successfully!');
            } else {
                alert('Error saving changes: ' + (response.error || 'Unknown error'));
            }
        },
        error: function(xhr, status, error) {
            alert('Error saving changes: ' + error);
            console.error('Save error:', xhr.responseText);
        },
        complete: function() {
            $saveBtn.html(originalText).prop('disabled', false);
        }
    });
}

function resetAllChanges() {
    if (Object.keys(cellChanges).length === 0) {
        alert('No changes to reset.');
        return;
    }
    
    if (confirm('Are you sure you want to reset all changes?')) {
        Object.keys(cellChanges).forEach(cellKey => {
            const change = cellChanges[cellKey];
            const $cell = $(`.editable-cell[data-row="${change.rowIndex}"][data-column="${change.column}"]`);
            $cell.html(change.oldValue).removeClass('cell-changed');
        });
        
        cellChanges = {};
        updateChangeIndicator();
    }
}

// Proceed to sensitivity parameters function
function proceedToSensitivityParameters() {
    window.location.href = "{% url 'climate_hazards_analysis_v2:sensitivity_parameters' %}";
}
</script>

{% endblock %}